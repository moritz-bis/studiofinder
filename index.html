<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>studio-finder</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>studio finder</h1>
  <p id="stats"></p>

  <label for="countryFilter">country:</label>
  <select id="countryFilter">
    <option value="all">all countries</option>
  </select>

  <label for="cityFilter">city:</label>
  <select id="cityFilter">
    <option value="all">all cities</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>name</th>
        <th>website</th>
        <th>city</th>
        <th>country</th>
        <th>tags</th>
      </tr>
    </thead>
    <tbody id="studioTableBody"></tbody>
  </table>

<script>
  let studios = [];

  const tbody = document.getElementById("studioTableBody");
  const countryFilter = document.getElementById("countryFilter");
  const cityFilter = document.getElementById("cityFilter");

  const viewId = "FaO2AXrrzWaa1b9xYNO9M4xSBodrbcsGA86TcytQlaI"; // <- DEIN VIEW-ID
  const baseUrl = `https://api.baserow.io/api/public/database/rows/view/${viewId}/?user_field_names=true`;

  async function loadStudios() {
    studios = [];
    let offset = 0;
    const limit = 100;
    let moreData = true;

    try {
      while (moreData) {
        const response = await fetch(`${baseUrl}&limit=${limit}&offset=${offset}`);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.json();
        studios = studios.concat(data.results);

        if (data.results.length < limit) {
          moreData = false;
        } else {
          offset += limit;
        }
      }

      console.log("Studios geladen:", studios.length);
      initDropdowns(studios);
      renderStudios();
    } catch (error) {
      console.error("Fehler beim Laden der Studiendaten:", error);
    }
  }

  function initDropdowns(studios) {
    const allCountries = new Set();
    const allCities = new Set();

    studios.forEach(studio => {
      (studio.country || []).forEach(c => allCountries.add(c.value || c));
      (studio.city || []).forEach(c => allCities.add(c.value || c));
    });

    Array.from(allCountries).sort().forEach(country => {
      const opt = document.createElement("option");
      opt.value = country;
      opt.textContent = country;
      countryFilter.appendChild(opt);
    });

    Array.from(allCities).sort().forEach(city => {
      const opt = document.createElement("option");
      opt.value = city;
      opt.textContent = city;
      cityFilter.appendChild(opt);
    });
  }

  function updateStats(visibleStudios) {
    const statsElement = document.getElementById("stats");
    const numStudios = visibleStudios.length;
    const citySet = new Set();

    visibleStudios.forEach(studio => {
      (studio.city || []).forEach(city => citySet.add(city.value || city));
    });

    statsElement.textContent = `${numStudios} studios in ${citySet.size} cities`;
  }

  function renderStudios() {
    const selectedCountry = countryFilter.value;
    const selectedCity = cityFilter.value;

    const filtered = studios.filter(studio => {
      const countries = (studio.country || []).map(c => c.value || c);
      const cities = (studio.city || []).map(c => c.value || c);

      const countryMatch = selectedCountry === "all" || countries.includes(selectedCountry);
      const cityMatch = selectedCity === "all" || cities.includes(selectedCity);

      return countryMatch && cityMatch;
    });

    tbody.innerHTML = "";
    updateStats(filtered);

    filtered.forEach(studio => {
      const row = document.createElement("tr");
      const websiteLink = studio.website ? `<a href="${studio.website}" target="_blank">${studio.website}</a>` : "";

      row.innerHTML = `
        <td>${studio.name || ""}</td>
        <td>${websiteLink}</td>
        <td>${(studio.city || []).map(c => c.value || c).join(', ')}</td>
        <td>${(studio.country || []).map(c => c.value || c).join(', ')}</td>
        <td>${(studio.tags || []).map(tag => `<span class="tag">${tag.value || tag}</span>`).join(' ')}</td>
      `;

      tbody.appendChild(row);
    });
  }

  countryFilter.addEventListener("change", renderStudios);
  cityFilter.addEventListener("change", renderStudios);

  loadStudios();
</script>

</body>
</html>
